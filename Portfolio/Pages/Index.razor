@using Application.Interfaces.Services
@using static Application.Contracts.DTOs.Response
@using Application.Classes
@attribute [Route(ApplicationConstants.Routes.Index)]

@inject IPersonalInfoService PersonalInfoService
@inject ISnackbar Snackbar
@inject ISocialsService SocialsService
@inject IHobbiesService HobbiesService
@inject ISkillsService SkillsService
@inject IWorkService WorkService
@inject IEducationService EducationService
@inject IProjectService ProjectService

<div class="container py-3">

    <!-- Row 1 -->
    <div class="row g-3">
        <div class="col-12 col-lg-8">
            <Portfolio.Components.PersonalInfoComponent Error="@ErrorPersonalInfo"
                                                        Socials="@Socials"
                                                        Info="@Info"
                                                        IsLoading="@IsLoading"
                                                        OnRetry="@LoadPersonalInfoAndSocialsAsync" />
        </div>

        <div class="col-12 col-lg-4">
            <Portfolio.Components.HobbyComponent Hobbies="@Hobbies"
                                                    Error="@ErrorHobbies"
                                                    IsLoading="@IsLoading"
                                                    OnRetry="@LoadHobbiesAsync"
                                                    ViewAllUrl="@ApplicationConstants.Routes.HobbiesPage" />
        </div>
    </div>

    <!-- Row 2 -->
    <div class="row g-3 mt-3">
        <div class="col-12 col-lg-4">
            <Portfolio.Components.SkillsComponent Skills="@Skills"
                                                    Error="@ErrorSkills"
                                                    IsLoading="@IsLoading"
                                                    OnRetry="@LoadSkillsAsync"
                                                    ViewAllUrl="@ApplicationConstants.Routes.SkillsPage" />
        </div>

        <div class="col-12 col-lg-8">
            <Portfolio.Components.WorkExperience Works="@Works"
                                                    Error="@ErrorWork"
                                                    IsLoading="@IsLoading"
                                                    OnRetry="@LoadWorkAsync"
                                                    ViewAllUrl="@ApplicationConstants.Routes.WorkPage" />
        </div>
    </div>

    <!-- Row 3 -->
    <div class="row g-3 mt-3">
        <div class="col-12 col-lg-4">
                <Portfolio.Components.EducationExperienceComponent Educations="@Educations"
                                                                   Error="@ErrorEducation"
                                                                   IsLoading="@IsLoading"
                                                                   OnRetry="@LoadEducationAsync"
                                                                   ViewAllUrl="@ApplicationConstants.Routes.EducationPage" />
        </div>

        <div class="col-12 col-lg-8">
                <Portfolio.Components.ProjectsInfoComponent Projects="@ProjectsDto"
                                                            Error="@ErrorProject"
                                                            IsLoading="@IsLoading"
                                                            OnRetry="@LoadProjectsAsync"
                                                            ViewAllUrl="@ApplicationConstants.Routes.ProjectsPage" />
        </div>
    </div>

</div>

@code
{

    public bool IsLoading { get; set; } = true;

    #region ##### Error Messages #####

    public string? ErrorPersonalInfo { get; set; }
    public string? ErrorHobbies { get; set; }
    public string? ErrorSkills { get; set; }
    public string? ErrorWork { get; set; }
    public string? ErrorEducation { get; set; }
    public string? ErrorProject { get; set; }

    #endregion

    #region ##### Busy Booleans #####

    private bool _isBusyPersonalInfo = false;
    private bool _isBusyHobbies = false;
    private bool _isBusySkills = false;
    private bool _isBusyWork = false;
    private bool _isBusyEducation = false;
    private bool _isBusyProject = false;

    #endregion

    private PersonalInfoDto? Info { get; set; }
    private IEnumerable<SocialDto>? Socials { get; set; }
    private IEnumerable<HobbyDto>? Hobbies { get; set; }
    private IEnumerable<SkillDto>? Skills { get; set; }
    private IEnumerable<WorkDto>? Works { get; set; }
    private IEnumerable<EducationDto>? Educations { get; set; }
    private IEnumerable<ProjectDto?> ProjectsDto { get; set; }

    protected override Task OnInitializedAsync() => LoadAsync();

    protected async Task LoadAsync()
    {
        try
        {
            IsLoading = true;

            List<Task> tasks = new List<Task>();

            tasks.Add(LoadPersonalInfoAndSocialsAsync());
            tasks.Add(LoadHobbiesAsync());
            tasks.Add(LoadSkillsAsync());
            tasks.Add(LoadWorkAsync());
            tasks.Add(LoadEducationAsync());
            tasks.Add(LoadProjectsAsync());

            await Task.WhenAll(tasks);
        }
        catch (Exception ex)
        {
            ErrorPersonalInfo = ex.Message;
            Snackbar.Add($"Unexpected error: {ex.Message}", Severity.Error, cfg =>
            {
                cfg.RequireInteraction = false;
                cfg.ShowCloseIcon = true;
            });
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    protected async Task LoadPersonalInfoAndSocialsAsync()
    {
        if (_isBusyPersonalInfo)
        {
            return;
        }

        _isBusyPersonalInfo = true;
        var resultPersonalInfo = await PersonalInfoService.GetPersonalInfoAsync();

        if (resultPersonalInfo == null)
        {
            ErrorPersonalInfo = "Personal Info Service returned no result.";
            return;
        }

        if (resultPersonalInfo.IsSuccess)
        {
            Info = resultPersonalInfo.Value;
        }
        else
        {
            ErrorPersonalInfo = string.IsNullOrWhiteSpace(resultPersonalInfo.ErrorMessage) ? "Failed to load personal info." : resultPersonalInfo.ErrorMessage;
            Snackbar.Add(ErrorPersonalInfo, Severity.Error, cfg => cfg.RequireInteraction = false);
        }

        var resultSocials = await SocialsService.GetSocialsAsync();

        if (resultSocials.IsSuccess)
        {
            Socials = resultSocials.Value;
        }
        else
        {
            ErrorPersonalInfo = string.IsNullOrWhiteSpace(resultSocials.ErrorMessage) ? "Failed to load socials." : resultSocials.ErrorMessage;
        }

        _isBusyPersonalInfo = false;
        StateHasChanged();
    }

    protected async Task LoadHobbiesAsync()
    {
        if (_isBusyHobbies)
        {
            return;
        }

        _isBusyHobbies = true;
        var resultHobbiesService = await HobbiesService.GetHobbiesAsync();

        if (resultHobbiesService == null)
        {
            ErrorHobbies = "Hobbies Service returned no result.";
            return;
        }

        if (resultHobbiesService.IsSuccess)
        {
            Hobbies = resultHobbiesService.Value;
        }
        else
        {
            ErrorHobbies = string.IsNullOrWhiteSpace(resultHobbiesService.ErrorMessage) ? "Failed to load hobbies info." : resultHobbiesService.ErrorMessage;
            Snackbar.Add(ErrorHobbies, Severity.Error, cfg => cfg.RequireInteraction = false);
        }
        _isBusyHobbies = false;
        StateHasChanged();
    }

    protected async Task LoadSkillsAsync()
    {
        if (_isBusySkills)
        {
            return;
        }

        _isBusySkills = true;
        var resultSkills = await SkillsService.GetSkillsAsync();

        if (resultSkills == null)
        {
            ErrorSkills = "Skills Service returned no result.";
            return;
        }

        if (resultSkills.IsSuccess)
        {
            Skills = resultSkills.Value;
        }
        else
        {
            ErrorSkills = string.IsNullOrWhiteSpace(resultSkills.ErrorMessage) ? "Failed to load skills info." : resultSkills.ErrorMessage;
            Snackbar.Add(ErrorSkills, Severity.Error, cfg => cfg.RequireInteraction = false);
        }
        _isBusySkills = false;
        StateHasChanged();
    }

    protected async Task LoadWorkAsync()
    {
        if (_isBusyWork)
        {
            return;
        }

        _isBusyWork = true;
        var resultWorks = await WorkService.GetWorksAsync();

        if (resultWorks == null)
        {
            ErrorWork = "Work Service returned no result.";
            return;
        }

        if (resultWorks.IsSuccess)
        {
            Works = resultWorks.Value;
        }
        else
        {
            ErrorWork = string.IsNullOrWhiteSpace(resultWorks.ErrorMessage) ? "Failed to load work info." : resultWorks.ErrorMessage;
            Snackbar.Add(ErrorWork, Severity.Error, cfg => cfg.RequireInteraction = false);
        }
        _isBusyWork = false;
        StateHasChanged();

    }

    protected async Task LoadEducationAsync()
    {
        if (_isBusyEducation)
        {
            return;
        }

        _isBusyEducation = true;
        var resultEducation = await EducationService.GetEducationsAsync();

        if (resultEducation == null)
        {
            ErrorEducation = "Education Service returned no result.";
            return;
        }

        if (resultEducation.IsSuccess)
        {
            Educations = resultEducation.Value;
        }
        else
        {
            ErrorEducation = string.IsNullOrWhiteSpace(resultEducation.ErrorMessage) ? "Failed to load education info." : resultEducation.ErrorMessage;
            Snackbar.Add(ErrorEducation, Severity.Error, cfg => cfg.RequireInteraction = false);
        }
        _isBusyEducation = false;
        StateHasChanged();

    }

    protected async Task LoadProjectsAsync()
    {
        if (_isBusyProject)
        {
            return;
        }

        _isBusyProject = true;
        var resultProjects = await ProjectService.GetProjectsAsync();

        if (resultProjects == null)
        {
            ErrorProject = "Project Service returned no result.";
            return;
        }

        if (resultProjects.IsSuccess)
        {
            ProjectsDto = resultProjects.Value;
        }
        else
        {
            ErrorProject = string.IsNullOrWhiteSpace(resultProjects.ErrorMessage) ? "Failed to load project info." : resultProjects.ErrorMessage;
            Snackbar.Add(ErrorProject, Severity.Error, cfg => cfg.RequireInteraction = false);
        }
        _isBusyProject = false;
        StateHasChanged();

    }
}